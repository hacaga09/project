package com.example.gameproject;

import javafx.animation.AnimationTimer;
import javafx.application.Application;
import javafx.geometry.Bounds;
import javafx.geometry.Point2D;
import javafx.scene.Cursor;
import javafx.scene.Node;
import javafx.scene.Scene;
import javafx.scene.image.Image;
import javafx.scene.image.ImageView;
import javafx.scene.input.KeyCode;
import javafx.scene.input.KeyEvent;
import javafx.scene.input.MouseEvent;
import javafx.scene.layout.Pane;
import javafx.scene.paint.Color;
import javafx.scene.transform.Scale;
import javafx.stage.Stage;

import java.util.*;

public class Main extends Application {
    private static final double zoom=2.5;
    private final double screenw=1920;
    private final double screenh=1080;
    private final double centerx=screenw/2.0;
    private final double centery=screenh/2.0;

    public ImageView bgr=new ImageView(new Image("C:\\Users\\hacag\\Downloads\\Telegram Desktop\\photo_2025-11-11_18-05-27.jpg"));

    public final Set<KeyCode> keys=new HashSet<>();
    public Pane map;
    public Pane walls;
    public List<Bullet> bullets=new ArrayList<>();

    private boolean shooting=false;
    private long lastshot=0;
    private long firerate=150000000;

    @Override
    public void start(Stage stage){
        Controller controller=new Controller();
        stage.setTitle("Hotline JavaFX");

        map=new Pane();
        bgr.setLayoutX(0);
        bgr.setLayoutY(0);

        map.getTransforms().add(new Scale(zoom, zoom, 0, 0));
        map.getChildren().add(bgr);

        walls=new Pane();
        walls.getChildren().addAll(wall.lowerWall);
        map.getChildren().add(walls);

        chr.X=centerx;
        chr.Y=centery;
        chr.Xc=centerx;
        chr.Yc=centery;

        chr.hitbox.setFill(Color.TRANSPARENT);
        chr.hitbox.setStroke(Color.TRANSPARENT);

        cursor.im.setScaleX(0.1);
        cursor.im.setScaleY(0.1);

        Pane root=new Pane();
        root.getChildren().addAll(map, chr.hitbox, chr.im, cursor.im);

        Scene scene=new Scene(root, screenw, screenh);
        scene.setCursor(Cursor.NONE);

        scene.addEventFilter(KeyEvent.KEY_PRESSED, event -> {
            keys.add(event.getCode());
        });
        scene.addEventFilter(KeyEvent.KEY_RELEASED, event -> {
            keys.remove(event.getCode());
        });

        stage.focusedProperty().addListener((obs, oldVal, newVal) -> {
            if(!newVal){
                keys.clear();
                shooting=false;
            }
        });

        scene.addEventFilter(MouseEvent.MOUSE_MOVED, this::mouse);
        scene.addEventFilter(MouseEvent.MOUSE_DRAGGED, this::mouse);
        scene.addEventFilter(MouseEvent.MOUSE_PRESSED, event -> {
            shooting=true;
        });
        scene.addEventFilter(MouseEvent.MOUSE_RELEASED, event -> {
            shooting=false;
        });

        new AnimationTimer(){
            @Override
            public void handle(long now){
                if(!keys.isEmpty()){
                    move(controller);
                }

                if(shooting && (now-lastshot >= firerate)){
                    shoot();
                    lastshot=now;
                }

                updbullets();
                fixpos();
            }
        }.start();

        stage.setScene(scene);
        stage.setResizable(false);
        stage.show();
    }

    private void fixpos(){
        double imgw=chr.im.getImage().getWidth();
        double imgh=chr.im.getImage().getHeight();
        if(imgw==0){
            return;
        }

        chr.im.setX(centerx-imgw/2);
        chr.im.setY(centery-imgh/2);

        chr.hitbox.setX(centerx-chr.hwidth/2);
        chr.hitbox.setY(centery-chr.hheight/2);
    }

    private void move(Controller controller){
        if(keys.contains(KeyCode.W) && !hit(0, chr.speed)){
            controller.moveUp(map);
        }
        if(keys.contains(KeyCode.S) && !hit(0, -chr.speed)){
            controller.moveDown(map);
        }
        if(keys.contains(KeyCode.A) && !hit(chr.speed, 0)){
            controller.moveLeft(map);
        }
        if(keys.contains(KeyCode.D) && !hit(-chr.speed, 0)){
            controller.moveRight(map);
        }
    }

    private void shoot(){
        double rot=chr.im.getRotate();
        double dist=80;

        double rad=Math.toRadians(rot);
        double mx=centerx+(Math.sin(rad)*dist);
        double my=centery-(Math.cos(rad)*dist);

        Point2D p=map.sceneToLocal(mx, my);

        Bullet b=new Bullet(p.getX(), p.getY(), rot);
        bullets.add(b);
        map.getChildren().add(b.body);
    }

    private void updbullets(){
        Iterator<Bullet> iter=bullets.iterator();
        while(iter.hasNext()){
            Bullet b=iter.next();
            int steps=5;

            for(int i=0; i<steps; i++){
                b.step(1.0/steps);

                boolean hitWall=false;

                for(int j=0; j<walls.getChildren().size(); j++){
                    Node n=walls.getChildren().get(j); // Берем стену по номеру j

                    if(b.body.getBoundsInParent().intersects(n.getBoundsInParent())){
                        b.dead=true;
                        hitWall=true;
                        break;
                    }
                }

                if(hitWall){
                    break;
                }
            }

            if(b.dead){
                map.getChildren().remove(b.body);
                iter.remove();
            }
        }
    }

    private boolean hit(double dx, double dy){
        double nmx=map.getLayoutX()+dx;
        double nmy=map.getLayoutY()+dy;

        for(int i=0; i<walls.getChildren().size(); i++){
            Node n=walls.getChildren().get(i);
            Bounds b=n.localToScene(n.getBoundsInLocal());

            double wx=b.getMinX()+(nmx-map.getLayoutX());
            double wy=b.getMinY()+(nmy-map.getLayoutY());

            if(centerx+chr.hwidth/2 > wx &&
                    centerx- chr.hwidth/2 < wx+b.getWidth() &&
                    centery+chr.hheight/2 > wy &&
                    centery-chr.hheight/2 < wy+b.getHeight()){
                return true;
            }
        }
        return false;
    }

    private void mouse(MouseEvent event){
        cursor.im.setLayoutX(event.getX()-cursor.im.getImage().getWidth()/2);
        cursor.im.setLayoutY(event.getY()- cursor.im.getImage().getWidth()/2);

        double dx=event.getX()-centerx;
        double dy=event.getY()-centery;

        chr.rot=Math.toDegrees(Math.atan2(dy, dx));
        double ang=chr.rot+90;

        chr.im.setRotate(ang);
        chr.hitbox.setRotate(ang);
    }

    public static void main(String[] args){
        launch();
    }
}
